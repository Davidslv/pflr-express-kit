{% extends 'admin/admin-base/admin-base.html' %}

{% block page_title %}
{{block}} - Block
{% endblock %}

{% block admin_content %}
{% set _blockType = getBlockProp(block, '_blockType') %}
<p><a class="link-back" href="/admin/blocks/{{ _blockType }}">Back to {{ _blockType }} blocks</a></p>

<h1 class="{{ govukClassname('heading-large') }}">
{% if new %}
Create new {{ _blockType }}
{% else %}
{{ block }}
{% if _blockType == 'Route' %}
{# {% set routeUrl = getBlockProp(block, 'url') %} #}
{% set routeUrl = getRouteUrl(block) %}
{% if routeUrl %}
<small>route url <a href="{{ routeUrl }}">{{ routeUrl }}</a> <a href="{% if routeUrl != '/' %}{{ routeUrl }}{% endif %}/edit">(edit)</a></small>
{% endif %}
{% endif %}
{% endif %}
</h1>

{% set blockRefs = getBlockRef(block) %}
{% if blockRefs[0] %}
<h3>Used by</h3>
<ul>
{% for ref in blockRefs %}
<li><a href="/admin/block/{{ ref.block }}">{{ ref.block }} ({{ getBlockProp(ref.block, ['heading', 'label']) }})</a> in <a href="/admin/block/{{ ref.block }}/{{ ref.prop }}">{{ ref.prop }}</a></li>
{% endfor %}
</ul>
{% endif %}

{% if new %}
<form method="post">
 {{ Block.Text('_id', label='Id for new '+_blockType) }}
 {% if isaOptions %}
{{ Block.RadioGroup('_isa', label='Using', options=isaOptions )}}
 {% endif %}
 <div class="hidden">
{{ Block.Hidden('init', value=true) }}
 {{ Block.Hidden('singleblock', value=req.query.singleblock) }}
{{ Block.Hidden('steps', value=req.query.steps) }}
{{ Block.Text('block', value=blockJSON, multiline=true, rows=1) }}
 </div>
 <div class="admin-actions">
 <button name="action" value="update" class="{{ govukClassname('button') }}">Create new {{ _blockType }}</button>
 </div>
</form>
{% else %}
{% set propsLabel = {other: 'Other properties', additional: 'Additional properties', advanced: 'Advanced properties', meta: 'Meta properties'} %}
{% if init %}
{% set propRefs = { init: initProps, other: otherProps, advanced: advancedProps} %}
{% else %}
{% set propRefs = { schema: schemaProps, advanced: advancedProps, additional: additionalProps, meta: metaProps} %}
{% endif %}
{% for propRef, propRefValue in propRefs %}
{% if propRefValue %}
{% set outputProps = propRefValue %}
{% set summaryRequired = true %}
{% if propRef == 'init' or propRef == 'schema' %}
{% set summaryRequired = false %}
{% endif %}

{% if outputProps.length %}

{% if summaryRequired %}
<details>
    <summary><span class="summary">{{ propsLabel[propRef] }}</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
{% endif %}

<ul class="blockProperties {{ govukClassname('list-bullet') }}">
{% for prop in outputProps %}
{% set rawBlock = getBlockRaw(block) %}
{% set blockProp = rawBlock[prop] %}
{% set blockPropType = typeof(blockProp ) %}
{% set propTitle = prop %}
{% if schemaProperties[prop] %}
{% set blockPropType = schemaProperties[prop].type %}
{% set propTitle = schemaProperties[prop].title %}
{% endif %}
{% set propBlockRef = '' %}
{% if blockPropType == 'string' %}
{% set propBlockRef = getBlockProp(blockProp, '_id') %}
{% endif %}
<li class="blockProp">{% if prop != 'xdepends' %}<a href="/admin/block/{{ block }}/{{ prop }}">{% endif %}{{ propTitle }}{% if not requiredProps[prop] %} <small class="optional">(optional)</small>{% endif %}{% if prop != 'xdepends' %}</a>{% endif %}
{% if blockPropType == 'string' %}
{# {{ Block.Text(prop, value=blockProp)}} #}
{% endif %}
<small class="blockProp__value">
{% if prop == 'depends' %}
{{ blockProp | json | replace('[{"', '')  | replace('}]', '') | replace('":', ':') }}
{% else %}{% if false and blockProp.trim %}{% set formatted = getFormattedBodyContent(block, prop) %}{% if formatted != blockProp %}{{ formatted  | truncate(120) }}{% endif %}{% endif %}
{% if propBlockRef %}<a href="/admin/block/{{ blockProp }}">{% endif %}
{% if blockProp %}{{ blockProp | json | replace(r/^"(.*)"$/, '$1') | truncate(120) }}{% else %}<em>Not set</em>
{% set inheritedValue = getBlockProp(block, prop) %}{% if inheritedValue %}<br>Inherited value:<br>{{ inheritedValue | truncate(120) | safe }}{% endif %}{% endif %}
{% if propBlockRef %}</a>{% endif %}
{% endif %}
</small>
{% if prop == 'block' %}<a href="/admin/select/block/{{ block }}?singleblock={{block}}" target="new-block">Add new block</a>{% endif %}
</li>
{% endfor %}
</ul>

{% if summaryRequired %}
</div>
</details>
{% endif %}

{% endif %}

{% endif %}
{% endfor %}

<form method="post">
<details>
  <summary><span class="summary">Edit raw block</span></summary>
  <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('block', value=blockJSON, multiline=true, rows=1) }}
  </div>
  <details>
    <summary><span class="summary">View expanded block</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
      {# <h2 class="{{ govukClassname('heading-medium') }}">Expanded JSON</h2> #}
      <p class="blockJSONExpanded">{{blockJSONExpanded | safe}}</p>
    </div>
  </details>
  <div class="admin-actions">
  <button name="action" value="update" class="{{ govukClassname('button') }}">Update {{ block }}</button>
  </div>
</details>


  <div class="admin-actions">
    <details>
    <summary><span class="summary">Add property</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('propName', label='Property name')}}
    <button name="action" value="prop" class="{{ govukClassname('button') }}">Add property</button>
    </div>
  </details>
    <details>
    <summary><span class="summary">Clone block</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('cloneId', label='New id')}}
    <button name="action" value="clone" class="{{ govukClassname('button') }}">Clone block</button>
    </div>
  </details>
  <button name="action" value="delete" class="{{ govukClassname('button') }} button--delete">Delete {{ block }}</button>
  </div>

</form>

{% endif %}

{% endblock %}

{% block body_end %}
{{ super() }}
<script>
var $form = jQuery('form')
$form.on('submit', function(e) {
  if ($form.attr('action') === '/id-exists') {
    e.preventDefault()
    e.stopPropagation()
    alert('A block with this id already exists')
  }
})
</script>
{% if new %}
<script>
var $id = jQuery('[name="_id"]')
var $block = jQuery('[name="block"]')
var blockJSON = JSON.parse($block.val())
$id.on('keyup', function() {
  var newId = $id.val()
  blockJSON._id = newId
  $form.attr('action', '/id-exists')
  jQuery.getJSON('/api/block/' + newId, function(json) {
    if (!json._id) {
      $block.val(JSON.stringify(blockJSON, null, 2))
      $form.attr('action', '/admin/block/' + newId)
    }
  })
})
</script>
{% else %}
<script>
var $cloneId = jQuery('[name="cloneId"]')
$cloneId.on('keyup', function() {
  var newId = $cloneId.val()
  $form.attr('action', '/id-exists')
  jQuery.getJSON('/api/block/' + newId, function(json) {
    if (!json._id) {
      $form.attr('action', '/admin/block/' + newId)
    }
  })
})
</script>
{% endif %}
{% endblock %}