{% extends 'admin/admin-base/admin-base.html' %}

{% block page_title %}
{{block}} - Block
{% endblock %}

{% block admin_content %}
{% set _blockType = getBlockProp(block, '_blockType') %}
{% if parentBlock or block == "route:index" %}
<!-- <p><a class="link-back" href="/admin/block/{{ parentBlock }}">Back to {{ parentBlock }} blocks</a></p> -->
<p class="edit-link-back"><a class="link-back" href="/admin/pages/#{{ block }}">All pages</a></p>
{% else %}
<p class="edit-link-back"><a class="link-back" href="/admin/blocks/{{ _blockType }}">Back to {{ _blockType }} blocks</a></p>
{% endif %}

<h1 class="{{ govukClassname('heading-large') }}">
{% if new %}
Create new {{ _blockType }}
{% else %}
{{ block }}
{% endif %}
</h1>
{% if not new %}
<p class="blockType"><small>Block type <a href="/admin/blocks/{{ _blockType }}" title="All {{ _blockType }} blocks">{{ _blockType }}</a></small></p>
{% set isa = getBlockProp(block, '_isa') %}
{% if isa %}
<p class="basedOn"><small>Based on <a href="/admin/block/{{ isa }}" title="{{ getBlockProp(previousRoute, ['heading', 'label']) }}">{{ isa }}</a></small></p>
{% endif %}
{% if _blockType == 'Route' %}
{# {% set routeUrl = getBlockProp(block, 'url') %} #}
{% set routeUrl = getRouteUrl(block) %}
{% if routeUrl %}
<p class="route__links"><small>Route URL <a href="{{ routeUrl }}">{{ routeUrl }}</a> &nbsp;&nbsp;<a href="{% if routeUrl != '/' %}{{ routeUrl }}{% endif %}/edit">(edit view)</a></small></p>
{% endif %}
{% endif %}
{% endif %}

{% if nextRoute or previousRoute %}
<div class="route__navigation">
{% if previousRoute %}<p class="route__previous"><a href="/admin/block/{{ previousRoute }}" title="Previous route - {{ getBlockProp(previousRoute, 'heading') }}"><span class="route__direction">Previous page</span> {{ previousRoute }}</a></p>{% endif %}
{% if nextRoute %}<p class="route__next"><a href="/admin/block/{{ nextRoute }}" title="Next route - {{ getBlockProp(previousRoute, 'heading') }}"><span class="route__direction">Next page</span> {{ nextRoute }}</a></p>{% endif %}
</div>
{% endif %}

{% set blockRefs = getBlockRef(block) %}
{% if blockRefs.length %}{% set blockUsed = true %}{% endif %}
{% if blockRefs[0] %}
{% if blockRefs[1] %}
<details class="usedBy">
    <summary><span class="summary">Used by {{ blockRefs.length }} blocks</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
<ul>
{% for ref in blockRefs %}
<li><a href="/admin/block/{{ ref.block }}" title="{{ getBlockProp(ref.block, ['heading', 'label']) }}">{{ ref.block }}</a> in <a href="/admin/block/{{ ref.block }}/{{ ref.prop }}">{{ ref.prop }}</a></li>
{% endfor %}
</ul>
</div>
</details>
{% else %}
{% for ref in blockRefs %}
<p class="usedBy">Used by <a href="/admin/block/{{ ref.block }}" title="{{ getBlockProp(ref.block, ['heading', 'label']) }}">{{ ref.block }}</a> in <a href="/admin/block/{{ ref.block }}/{{ ref.prop }}">{{ ref.prop }}</a></p>
{% endfor %}
{% endif %}
{% endif %}

{% if new %}
<form method="post">
 {{ Block.Text('_id', label='Id for new '+_blockType) }}
 {% if isaOptions %}
{{ Block.RadioGroup('_isa', label='Using', options=isaOptions )}}
 {% endif %}
 <div class="hidden">
{{ Block.Hidden('init', value=true) }}
 {{ Block.Hidden('blockRef', value=req.query.blockRef) }}
{{ Block.Hidden('propertyRef', value=req.query.propertyRef) }}
{{ Block.Text('block', value=blockJSON, multiline=true, rows=1) }}
 </div>
 <div class="admin-actions">
 <button name="action" value="update" class="{{ govukClassname('button') }}">Create new {{ _blockType }}</button>
 </div>
</form>
{% else %}
<div class="properties--section">
{% set propsLabel = {other: 'Other properties', additional: 'Additional properties', validation: 'Validation', error: 'Error messages', advanced: 'Advanced properties', meta: 'Notes etc'} %}
{% if init %}
{% set propRefs = { init: initProps, validation: validationProps, error: errorProps, other: otherProps, advanced: advancedProps} %}
{% else %}
{% set propRefs = { schema: schemaProps, validation: validationProps, error: errorProps, advanced: advancedProps, additional: additionalProps, meta: metaProps} %}
{% endif %}
{% for propRef, propRefValue in propRefs %}
{% if propRefValue %}
{% set outputProps = propRefValue %}
{% set summaryRequired = true %}
{% if propRef == 'init' or propRef == 'schema' %}
{% set summaryRequired = false %}
{% endif %}

{% if outputProps.length %}

{% if summaryRequired %}
<details>
    <summary><span class="summary">{{ propsLabel[propRef] }}</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
{% endif %}

<ul class="blockProperties {{ govukClassname('list-bullet') }}">
{% for prop in outputProps %}
{% set rawBlock = getBlockRaw(block) %}
{% set blockProp = rawBlock[prop] %}
{% set blockPropType = typeof(blockProp ) %}
{% set propTitle = prop %}
{% if schemaProperties[prop] %}
{% set blockPropType = schemaProperties[prop].type %}
{% set blockPropBlockReference = schemaProperties[prop].blockReference %}
{% set propTitle = schemaProperties[prop].title %}
{% endif %}
{% set propBlockRef = '' %}
{% if blockPropType == 'string' %}
{% set propBlockRef = getBlockProp(blockProp, '_id') %}
{% endif %}
<li class="blockProp"><a href="{% if blockPropBlockReference %}/admin/select/block/{{ block }}?blockRef={{block}}&amp;propertyRef={{ prop }}{% else %}/admin/block/{{ block }}/{{ prop }}{% endif %}" class="edit-in-place">{{ propTitle }}</a>{% if not requiredProps[prop] %} <small class="optional">(optional)</small>{% endif %}
{# {% if blockPropType == 'string' %}
{{ Block.Text(prop, value=blockProp)}}
{% endif %} #}
<small class="blockProp__value">
{% if prop == 'depends' %}
{{ blockProp | json | replace('[{"', '')  | replace('}]', '') | replace('":', ':') }}
{% else %}{% if false and blockProp.trim %}{% set formatted = getFormattedBodyContent(block, prop) %}{% if formatted != blockProp %}{{ formatted  | truncate(120) }}{% endif %}{% endif %}
{% if propBlockRef %}<a href="/admin/block/{{ blockProp }}" class="edit-in-place">{% endif %}
{% if blockProp %}{{ blockProp | json | replace(r/^"(.*)"$/, '$1') | truncate(120) }}{% else %}<em>
{% set inheritedValue = getBlockProp(block, prop) %}{% if inheritedValue %}{{ inheritedValue | truncate(120) | safe }}{% else %}Not set{% endif %}</em>{% endif %}
{% if propBlockRef %}</a>{% endif %}
{% endif %}
</small>
{# {% if prop == 'block' %}<a href="/admin/select/block/{{ block }}?blockRef={{block}}&amp;propertyRef=block" target="new-block" class="edit-in-place">Add new block</a>{% endif %} #}
</li>
{% endfor %}
</ul>

{% if summaryRequired %}
</div>
</details>
{% endif %}

{% endif %}

{% endif %}
{% endfor %}
</div>

<form method="post">
<details>
  <summary><span class="summary">Edit raw block data</span></summary>
  <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('block', value=blockJSON, multiline=true, rows=1) }}
  </div>
  <details>
    <summary><span class="summary">View expanded block</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
      {# <h2 class="{{ govukClassname('heading-medium') }}">Expanded JSON</h2> #}
      <p class="blockJSONExpanded">{{blockJSONExpanded | safe}}</p>
    </div>
  </details>
  <div class="admin-actions">
  <button name="action" value="update" class="{{ govukClassname('button') }}">Update {{ block }}</button>
  </div>
</details>


  <div class="admin-actions">
    <details>
    <summary><span class="summary">Add property</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('propName', label='Property name')}}
    <button name="action" value="prop" class="{{ govukClassname('button') }}">Add property</button>
    </div>
  </details>
    <details>
    <summary><span class="summary">Clone block</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('cloneId', label='New id')}}
    <button name="action" value="clone" class="{{ govukClassname('button') }}">Clone block</button>
    </div>
  </details>
  <button name="action" value="delete" class="{{ govukClassname('button') }} button--delete button--destructive"{% if blockUsed %} disabled="disabled" title="This block is used by another block cannot be deleted"{% endif %}>Delete {{ block }}</button>
  </div>

</form>

{% endif %}

{% endblock %}

{% block stylesheet %}
{{ super() }}
<style>
#content .blockType {
  margin: -2rem 0 0 0;
}
#content .basedOn {
  margin: 0;
}
#content .usedBy {
  margin: 0;
}
#content .route__links {
  margin: 0;
}
.route__navigation {
  width: 100%;
  display: table;
}
.route__navigation p {
  float: left;
  width: 50%;
  position: relative;
}
.route__navigation a {
  padding-left: 2rem;
  position: relative;
  z-index: 1;
}
p.route__next {
  float: right;
  text-align: right;
}
.route__next a {
  padding: 0 2rem 0 0;
}
.route__navigation span {
  position: absolute;
  left: -9999px;
  width: 0;
  height: 0;
  overflow: hidden;
}
.route__navigation p::before {
  color: #2b8cc4;
  font-size: 4rem;
  position: absolute;
  top: -1.875rem;
}
.route__previous::before {
  left: 0;
  content: '‹';
}
.route__next {
  float: right;
}
.route__next::before {
  right: 0;
  content: '›';
}

.properties--section {
  margin-top: 3rem;
}
</style>
{% endblock %}

{% block body_end %}
{{ super() }}
<script>
var $form = jQuery('form')
$form.on('submit', function(e) {
  if ($form.attr('action') === '/id-exists') {
    e.preventDefault()
    e.stopPropagation()
    alert('A block with this id already exists')
  }
})
</script>
{% if new %}
<script>
var $id = jQuery('[name="_id"]')
var $block = jQuery('[name="block"]')
var blockJSON = JSON.parse($block.val())
$id.on('keyup', function() {
  var newId = $id.val()
  blockJSON._id = newId
  $form.attr('action', '/id-exists')
  jQuery.getJSON('/api/block/' + newId, function(json) {
    if (!json._id) {
      $block.val(JSON.stringify(blockJSON, null, 2))
      $form.attr('action', '/admin/block/' + newId)
    }
  })
})
</script>
{% else %}
<script>
var $cloneId = jQuery('[name="cloneId"]')
$cloneId.on('keyup', function() {
  var newId = $cloneId.val()
  $form.attr('action', '/id-exists')
  jQuery.getJSON('/api/block/' + newId, function(json) {
    if (!json._id) {
      $form.attr('action', '/admin/block/' + newId)
    }
  })
})
</script>
{% endif %}
{% endblock %}
