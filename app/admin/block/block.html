{% extends 'admin/admin-base/admin-base.html' %}

{% block page_title %}
{{block}} - Block
{% endblock %}

{% block admin_content %}
{% set _blockType = getBlockProp(block, '_blockType') %}
<p><a class="link-back" href="/admin/blocks/{{ _blockType }}">Back to {{ _blockType }} blocks</a></p>

<h1 class="{{ govukClassname('heading-large') }}">
{{ block }}
{% if _blockType == 'Route' %}
{# {% set routeUrl = getBlockProp(block, 'url') %} #}
{% set routeUrl = getRouteUrl(block) %}
{% if routeUrl %}
<small>route url <a href="{{ routeUrl }}">{{ routeUrl }}</a> <a href="{{ routeUrl }}/edit">(edit)</a></small>
{% endif %}
{% endif %}
</h1>

{% if new %}
{{ Block.Text('_id', label='Id for new '+_blockType+' block') }}
{% endif %}
{% if stringProps.length %}
<ul class="blockProperties {{ govukClassname('list-bullet') }}">
{% for prop in stringProps %}
{% set rawBlock = getBlockRaw(block) %}
{% set blockProp = rawBlock[prop] %}
{% set blockPropType = typeof(blockProp ) %}
{% set propBlockRef = '' %}
{% if blockPropType == 'string' %}
{% set propBlockRef = getBlockProp(blockProp, '_id') %}
{% endif %}
<li class="blockProp">{% if prop != 'depends' %}<a href="/admin/block/{{ block }}/{{ prop }}">{% endif %}{{ prop }}{% if prop != 'depends' %}</a>{% endif %}
<small class="blockProp__value">
{% if prop == 'depends' %}
{{ blockProp | json | replace('[{"', '')  | replace('}]', '') | replace('":', ':') }}
{% else %}
{% if propBlockRef %}<a href="/admin/block/{{ blockProp }}">{% endif %}{{ blockProp | json | replace(r/^"(.*)"$/, '$1') | truncate(120) }}{% if propBlockRef %}</a>{% endif %}
{% endif %}
</small>
</li>
{% endfor %}
</ul>
{% endif %}

<form method="post">
{% if new %}
  <div class="js-hidden">{{ Block.Text('block', value=blockJSON, multiline=true) }}</div>
  <div class="admin-actions">
  <button name="action" value="update" class="{{ govukClassname('button') }}">Create new {{_blockType}} block</button>
  </div>
{% else %}
<details>
  <summary><span class="summary">Edit raw block</span></summary>
  <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('block', value=blockJSON, multiline=true, rows=1) }}
  </div>
  <details>
    <summary><span class="summary">View expanded block</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
      {# <h2 class="{{ govukClassname('heading-medium') }}">Expanded JSON</h2> #}
      <p class="blockJSONExpanded">{{blockJSONExpanded | safe}}</p>
    </div>
  </details>
  <div class="admin-actions">
  <button name="action" value="update" class="{{ govukClassname('button') }}">Update {{ block }}</button>
  </div>
</details>


  <div class="admin-actions">
    <details>
    <summary><span class="summary">Add property</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('propName', label='Property name')}}
    <button name="action" value="prop" class="{{ govukClassname('button') }}">Add property</button>
    </div>
  </details>
    <details>
    <summary><span class="summary">Clone block</span></summary>
    <div class="{{ govukClassname('summary-details') }}">
    {{ Block.Text('cloneId', label='New id')}}
    <button name="action" value="clone" class="{{ govukClassname('button') }}">Clone block</button>
    </div>
  </details>
  <button name="action" value="delete" class="{{ govukClassname('button') }} button--delete">Delete {{ block }}</button>
  </div>
  {% endif %}

</form>

{% endblock %}

{% block body_end %}
{{ super() }}
{% if new %}
<script>
var $form = jQuery('form')
var $rawBlock = jQuery('[name="block"]')
var rawBlock = JSON.parse($rawBlock.val())
jQuery('[name="_id"]').on('keyup', function() {
  var id = jQuery(this).val()
  rawBlock._id = id
  $rawBlock.val(JSON.stringify(rawBlock, null, 2))
  $form.attr('action', '/admin/block/' + id)
})
</script>
{% endif %}
{% endblock %}